define(["core/ajax","core/str","core/notification","core/templates","mod_googlemeet/gapi"],function(a,b,c,d,e){return{init:function(f,g,h,i,j,k){function l(){e.client.init({apiKey:g,clientId:f,discoveryDocs:x,scope:y}).then(function(){E.onclick=m,E.disabled=!1})["catch"](function(a){E.disabled=!0,o(JSON.stringify(a,null,2))})}function m(){e.auth2.getAuthInstance().signIn({prompt:"select_account"}).then(function(){v()})["catch"]()}function n(a){var b=document.getElementById("googlemeet_syncimg");a?(b.style.display="flex",E.disabled=!0):(b.style.display="none",E.disabled=!1)}function o(a){var b=document.getElementById("googlemeetcontentlog"),c=document.createTextNode(a+"\n");b.style.display="block",b.appendChild(c)}function p(){var a=document.getElementById("googlemeetcontentlog");a.style.display="none",a.innerHTML=""}function q(a){e.client.drive.permissions.create({resource:{type:"anyone",role:"reader"},fileId:a,fields:"id"}).then()["catch"]()}function r(){var a="and (name contains '"+z+"'";return a+=" or name contains '"+h.originalname+"')"}function s(a){var b=Math.floor(parseInt(a,10)/1e3),c=Math.floor(b/3600),d=Math.floor((b-3600*c)/60),e=b-3600*c-60*d;return e<10&&(e="0"+e),c>0?(d<10&&(d="0"+d),c+":"+d+":"+e):d+":"+e}function t(a){d.render("mod_googlemeet/recordingstable",{recordings:a,coursemoduleid:j,hascapability:k}).then(function(a,b){n(!1),d.replaceNodeContents("#googlemeet_recordings_table",a,b),document.getElementById("id_creatoremail").innerHTML=w,document.getElementById("id_lastsync").innerHTML=(new Date).toLocaleString().substr(0,16)}).fail(c.exception).fail(function(){n(!1)})}function u(b){e.client.drive.files.list({q:"parents='"+b+"' and trashed=false and mimeType='video/mp4' "+r(),pageSize:1e3,fields:"files(id,name,permissionIds,createdTime,videoMediaMetadata,webViewLink)"}).then(function(b){var d=b.result.files;if(d&&d.length>0){for(var e=0;e<d.length;e++){var f=d[e];f.permissionIds.includes("anyoneWithLink")||q(f.id),d[e].recordingId=f.id,d[e].duration=s(f.videoMediaMetadata.durationMillis),d[e].createdTime=Math.floor(new Date(f.createdTime).getTime()/1e3),delete d[e].id,delete d[e].permissionIds,delete d[e].videoMediaMetadata}a.call([{methodname:"mod_googlemeet_sync_recordings",args:{googlemeetid:h.id,creatoremail:w,files:d,coursemoduleid:j}}])[0].then(function(a){t(a),i=!0}).fail(c.exception).fail(function(){n(!1)})}else{var g=C+' "'+z+'" ';h.originalname&&(g+=D+' "'+h.originalname+'"'),o(g),n(!1),i&&(n(!0),a.call([{methodname:"mod_googlemeet_delete_all_recordings",args:{googlemeetid:h.id,coursemoduleid:j}}])[0].then(function(a){t(a),i=!1,n(!1)}).fail(c.exception).fail(function(){n(!1)}))}})["catch"](function(a){n(!1),o(JSON.stringify(a.result.error,null,2))})}function v(){n(!0),p(),e.client.drive.files.list({q:"name='Meet Recordings'",pageSize:100,fields:"nextPageToken, files(id,owners)"}).then(function(a){var b=a.result.files;if(b&&b.length>0){if(!h.creatoremail||h.creatoremail===b[0].owners[0].emailAddress)return w=b[0].owners[0].emailAddress,void u(b[0].id);o(A),n(!1)}else o(B)})["catch"](function(a){n(!1),o(JSON.stringify(a.result.error,null,2))})}var w,x=["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],y="https://www.googleapis.com/auth/drive",z=h.url.substr(24,12),A="",B="",C="",D="";b.get_strings([{key:"notpossiblesync",component:"mod_googlemeet"},{key:"notfoundrecordingsfolder",component:"mod_googlemeet"},{key:"notfoundrecordingname",component:"mod_googlemeet"},{key:"or",component:"mod_googlemeet"}]).done(function(a){A=a[0],B=a[1],C=a[2],D=a[3]}).fail(c.exception);var E=document.getElementById("id_syncdrivebutton");e.load("client:auth2",l)}}});