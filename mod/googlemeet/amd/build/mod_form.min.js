define(["core/notification","core/str","mod_googlemeet/gapi"],function(a,b,c){return{init:function(d,e,f){function g(){c.client.init({apiKey:e,clientId:d,discoveryDocs:q,scope:r}).then(function(){x.onclick=k,x.disabled=!1})["catch"](function(a){x.disabled=!0,n(JSON.stringify(a,null,2))})}function h(a,b){var c=new FormData(C),d=c.get(a+"[year]"),e=c.get(a+"[month]"),f=c.get(a+"[day]");return e=("0"+e).slice(-2),f=("0"+f).slice(-2),b?d+"-"+e+"-"+f:d+e+f}function i(){var a=new FormData(C),b=a.get("starthour"),c=a.get("startminute"),d=a.get("endhour"),e=a.get("endminute");b=("0"+b).slice(-2),c=("0"+c).slice(-2),d=("0"+d).slice(-2),e=("0"+e).slice(-2);for(var f=b+":"+c+":00",g=d+":"+e+":00",i=h("eventdate",!0)+" "+f,j=h("eventenddate",!0)+" "+g,k=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],l=new Date(i),m=new Date(j),n=!1;l<=m;){if(!n)for(var o=0;o<=k.length;o++){var p=k[l.getDay()],q=a.get("days["+k[o]+"]");if(q&&p===k[o]){n=!0;break}}l=new Date(l.setDate(l.getDate()+1))}return n}function j(){var a=!0,b=new FormData(C),c=document.getElementById("id_name"),d=document.getElementById("id_error_name");if(0===b.get("name").trim().length)return c.classList.add("is-invalid"),c.focus(),d.innerText="- "+s,d.style.display="block",!1;c.classList.remove("is-invalid"),d.innerText="",d.style.display="none";var e=document.getElementById("id_googlemeet_eventtime_error"),f=3600*b.get("starthour")+60*b.get("startminute"),g=3600*b.get("endhour")+60*b.get("endminute");if(g<f)return e.innerText=u,e.style.display="block",document.getElementById("id_endhour").focus(),!1;e.innerText="",e.style.display="none";var j=Math.floor(new Date(h("eventdate",!0)).getTime()/1e3),k=Math.floor(new Date(h("eventenddate",!0)).getTime()/1e3),l=document.getElementById("id_googlemeet_eventenddategroup_error");if(b.get("addmultiply")&&0!==j&&0!==k&&k<j)return l.innerText=v,l.style.display="block",document.getElementById("id_eventenddate_day").focus(),!1;if(b.get("addmultiply")&&Math.ceil((k-j)/31536e3)>1)return l.innerText=w,l.style.display="block",document.getElementById("id_eventenddate_day").focus(),!1;if(l.innerText="",l.style.display="none",b.get("addmultiply")){var m=document.getElementById("id_googlemeet_days_error");if(!i())return m.innerText=t,m.style.display="block",document.getElementById("id_days_Mon").focus(),!1;m.innerText="",m.style.display="none"}return a}function k(){o(),j()&&c.auth2.getAuthInstance().signIn({prompt:"select_account"}).then(function(){p()})["catch"]()}function l(a){var b=document.getElementById("generateurlroomLoading");a?(b.style.display="block",x.disabled=!0):(b.style.display="none",x.disabled=!1)}function m(a){var b=Math.floor(8888*Math.random())+1111;return a+" ("+b+")"}function n(a){var b=document.getElementById("googlemeetcontentlog"),c=document.createTextNode(a+"\n");b.style.display="block",b.appendChild(c)}function o(){var a=document.getElementById("googlemeetcontentlog");a.style.display="none",a.innerHTML=""}function p(){var a=new FormData(C),b=a.get("starthour"),d=a.get("startminute"),e=a.get("endhour"),g=a.get("endminute");b=("0"+b).slice(-2),d=("0"+d).slice(-2),e=("0"+e).slice(-2),g=("0"+g).slice(-2);var i=b+":"+d+":00",j=e+":"+g+":00",k={dateTime:h("eventdate",!0)+"T"+i,timeZone:f},o={dateTime:h("eventdate",!0)+"T"+j,timeZone:f},p=[];if(a.get("addmultiply")){var q="INTERVAL="+a.get("period"),r="UNTIL="+h("eventenddate",!1)+"T235959Z",s="BYDAY=",t={Sun:"SU",Mon:"MO",Tue:"TU",Wed:"WE",Thu:"TH",Fri:"FR",Sat:"SA"};for(var u in t)a.get("days["+u+"]")&&(s+=t[u]+",");p=["RRULE:FREQ=WEEKLY;"+q+";"+r+";"+s]}var v=m(a.get("name")),w={summary:v,description:a.get("introeditor[text]"),start:k,end:o,recurrence:p};l(!0),c.client.calendar.events.insert({calendarId:"primary",resource:w}).then(function(a){var b=a.result,d={conferenceData:{createRequest:{requestId:b.id}}};c.client.calendar.events.patch({calendarId:"primary",eventId:b.id,resource:d,sendNotifications:!1,conferenceDataVersion:1}).then(function(a){var b=a.result;x.remove(),A.value=v,y.value=b.hangoutLink,z.value=b.hangoutLink,B.value=b.creator.email,document.getElementById("id_googlemeet_generateurlgroup_error").style.display="none",l(!1)})["catch"](function(a){n(JSON.stringify(a.result.error,null,2)),l(!1)})})["catch"](function(a){n(JSON.stringify(a.result.error,null,2)),l(!1)})}var q=["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"],r="https://www.googleapis.com/auth/calendar.events",s="",t="",u="",v="",w="";b.get_strings([{key:"requirednamefield",component:"mod_googlemeet"},{key:"checkweekdays",component:"mod_googlemeet"},{key:"invalideventendtime",component:"mod_googlemeet"},{key:"invalideventenddate",component:"mod_googlemeet"},{key:"timeahead",component:"mod_googlemeet"}]).done(function(a){s=a[0],t=a[1],u=a[2],v=a[3],w=a[4]}).fail(a.exception);var x=document.getElementById("id_generateurlroom"),y=document.getElementById("id_url"),z=document.getElementById("id_url_viewer"),A=document.getElementById("id_originalname"),B=document.getElementById("id_creatoremail"),C=document.querySelector("#region-main .mform");c.load("client:auth2",g)}}});